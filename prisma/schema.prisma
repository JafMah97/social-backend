generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}       

model User {
  id                          String              @id @default(cuid())
  username                    String              @unique
  email                       String              @unique
  passwordHash                String
  fullName                    String
  profileImage                String              @default("/uploads/default-avatar.png")
  coverImage                  String              @default("/uploads/default-cover.jpg")
  isPrivate                   Boolean             @default(false)
  isProfileComplete           Boolean             @default(false)
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime            @updatedAt
  isActive                    Boolean             @default(true)
  isBanned                    Boolean             @default(false)

  bio                         String?
  website                     String?
  location                    String?
  dateOfBirth                 DateTime?
  gender                      String?

  banReason                   String?
  lastLoginAt                 DateTime?
  lastIp                      String?
  phoneNumber                 String?
  deletedAt                   DateTime?

  emailVerified               Boolean             @default(false)
  codeExpiresAt               DateTime?
  emailVerificationToken      String?
  tokenExpiresAt              DateTime?
  verificationCode            String?
  resetPasswordToken          String?
  resetPasswordTokenExpiresAt DateTime?

  // Relations
  Comment                     Comment[]
  CommentAuthorInfo           CommentAuthorInfo[]
  CommentLike                 CommentLike[]

  blockedConversations        Conversation[]      @relation("BlockedByUser")
  conversationsAsUser1        Conversation[]      @relation("User1Conversations")
  conversationsAsUser2        Conversation[]      @relation("User2Conversations")

  followers                   Follow[]            @relation("Followers")
  following                   Follow[]            @relation("Following")
  receivedFollowRequests      FollowRequest[]     @relation("ReceivedRequests")
  sentFollowRequests          FollowRequest[]     @relation("SentRequests")

  Like                        Like[]
  PostLike                    PostLike[]

  receivedMessages            Message[]           @relation("RecipientMessages")
  sentMessages                Message[]           @relation("SenderMessages")

  notificationsSent           Notification[]      @relation("Actor")
  notificationsReceived       Notification[]      @relation("Recipient")

  Post                        Post[]
  Reporter                    Report[]            @relation("Reporter")
  SavedPost                   SavedPost[]
  sessions                    Session[]
  Story                       Story[]
  StoryHighlight              StoryHighlight[]
  StoryLike                   StoryLike[]
  StoryView                   StoryView[]
  UserActivityLog             UserActivityLog[]
  UserMedia                   UserMedia[]

  role                        UserRole?
  userSettings                UserSettings?
  userPreferences             UserPreferences?
  verifications               VerificationToken[]

  @@index([username])
  @@index([email])
  @@index([fullName])
}

model UserPreferences {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  language                Language  @default(EN)
  themeMode               ThemeMode @default(SYSTEM)
  timezone                String?
  locale                  String?
  showSensitiveContent    Boolean   @default(false)
  defaultPostVisibility   String?
  itemsPerPage            Int       @default(10)
  layout                  String    @default("comfortable")
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  user                    User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserSettings {
  id                 String              @id @default(cuid())
  userId             String              @unique
  emailNotifications Boolean             @default(true)
  pushNotifications  Boolean             @default(true)
  storyViewPrivacy   StoryPrivacySetting @default(EVERYONE)
  allowDirectMessages String             @default("EVERYONE") // EVERYONE, FOLLOWERS_ONLY, NO_ONE
  showOnlineStatus   Boolean             @default(true)
  showReadReceipts   Boolean             @default(true)
  allowTagging       Boolean             @default(true)
  allowSharing       Boolean             @default(true)
  contentVisibility  String              @default("PUBLIC") // PUBLIC, FOLLOWERS_ONLY, PRIVATE
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserRole {
  id         String   @id @default(cuid())
  userId     String   @unique
  role       Role     @default(USER)
  assignedAt DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  id        String           @id @default(cuid())
  userId    String
  token     String           @unique
  type      VerificationType
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Post {
  id            String         @id @default(cuid())
  authorId      String
  title         String?
  content       String?
  image         String?
  format        PostFormat     @default(TEXT)
  postType      PostType       @default(STANDARD)
  visibility    PostVisibility @default(PUBLIC)
  isSponsored   Boolean        @default(false)
  startsAt      DateTime?
  endsAt        DateTime?
  isFlagged     Boolean        @default(false)
  flagReason    String?
  isDeleted     Boolean        @default(false)
  deletedAt     DateTime?
  likesCount    Int            @default(0)
  commentsCount Int            @default(0)
  viewsCount    Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  comments      Comment[]
  Like          Like[]
  notifications Notification[]
  author        User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
  PostLikes     PostLike[]
  tags          PostTag[]
  reports       Report[]
  savedBy       SavedPost[]

  @@index([authorId])
  @@index([createdAt])
  @@index([postType])
  @@index([title])
  @@index([content])
}

model SavedPost {
  id         String    @id @default(cuid())
  userId     String
  postId     String
  savedAt    DateTime  @default(now())
  isRemoved  Boolean   @default(false)
  removedAt  DateTime?
  postTitle  String?
  postImage  String?
  postAuthor String?
  post       Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@index([savedAt])
}

model PostLike {
  id        String    @id @default(cuid())
  userId    String
  postId    String
  likedAt   DateTime  @default(now())
  isRemoved Boolean   @default(false)
  removedAt DateTime?
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
  @@index([likedAt])
}

model Tag {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  posts       PostTag[]

  @@index([name])
}

model PostTag {
  postId     String
  tagId      String
  assignedAt DateTime @default(now())
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
  @@index([tagId])
  @@index([postId])
}

model Comment {
  id                String              @id @default(cuid())
  postId            String
  authorId          String
  content           String
  authorUsername    String?
  authorImage       String?
  isFlagged         Boolean             @default(false)
  flagReason        String?
  isDeleted         Boolean             @default(false)
  deletedAt         DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  author            User                @relation(fields: [authorId], references: [id], onDelete: Cascade)
  post              Post                @relation(fields: [postId], references: [id], onDelete: Cascade)
  CommentAuthorInfo CommentAuthorInfo[]
  commentLikes      CommentLike[]

  @@index([postId])
  @@index([authorId])
  @@index([content])
}

model CommentLike {
  id        String    @id @default(cuid())
  userId    String
  commentId String
  likedAt   DateTime  @default(now())
  isRemoved Boolean   @default(false)
  removedAt DateTime?
  comment   Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([commentId])
  @@index([userId])
  @@index([likedAt])
}

model CommentAuthorInfo {
  id             String    @id @default(cuid())
  commentId      String
  authorId       String
  authorUsername String?
  authorImage    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isDeleted      Boolean   @default(false)
  deletedAt      DateTime?
  isFlagged      Boolean   @default(false)
  flagReason     String?
  author         User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comment        Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([commentId])
  @@index([createdAt])
}

model Like {
  id        String    @id @default(cuid())
  userId    String
  postId    String
  likedAt   DateTime  @default(now())
  isRemoved Boolean   @default(false)
  removedAt DateTime?
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([postId])
  @@index([userId])
}

model Follow {
  id               String    @id @default(cuid())
  followerId       String
  followingId      String
  followerUsername String?
  followerFullName String?
  followerImage    String?
  isPending        Boolean   @default(false)
  isBlocked        Boolean   @default(false)
  isMuted          Boolean   @default(false)
  isRemoved        Boolean   @default(false)
  removedAt        DateTime?
  followedAt       DateTime  @default(now())
  follower         User      @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)
  following        User      @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model FollowRequest {
  id             String              @id @default(cuid())
  senderId       String
  receiverId     String
  status         FollowRequestStatus @default(PENDING)
  sentAt         DateTime            @default(now())
  respondedAt    DateTime?
  isAccepted     Boolean             @default(false)
  isRejected     Boolean             @default(false)
  isCancelled    Boolean             @default(false)
  cancelledAt    DateTime?
  senderUsername String?
  senderFullName String?
  senderImage    String?
  receiver       User                @relation("ReceivedRequests", fields: [receiverId], references: [id], onDelete: Cascade)
  sender         User                @relation("SentRequests", fields: [senderId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
}

model Notification {
  id          String           @id @default(cuid())
  userId      String
  actorId     String
  postId      String?
  storyId     String?
  messageId   String?
  type        NotificationType
  messageText String?
  title       String?
  link        String?
  icon        String?
  isRead      Boolean          @default(false)
  readAt      DateTime?
  isArchived  Boolean          @default(false)
  archivedAt  DateTime?
  isDeleted   Boolean          @default(false)
  deletedAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  actor       User             @relation("Actor", fields: [actorId], references: [id], onDelete: Cascade)
  message     Message?         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  post        Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)
  story       Story?           @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user        User             @relation("Recipient", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actorId])
  @@index([type])
  @@index([createdAt])
  @@index([isRead])
}

model UserMedia {
  id         String        @id @default(cuid())
  userId     String
  source     String?
  mediaType  UserMediaType @default(IMAGE)
  mediaUrl   String
  isPrivate  Boolean       @default(false)
  isFlagged  Boolean       @default(false)
  flagReason String?
  isDeleted  Boolean       @default(false)
  deletedAt  DateTime?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([mediaType])
}

model UserActivityLog {
  id         String       @id @default(cuid())
  userId     String
  action     ActivityType
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  isFlagged  Boolean      @default(false)
  flagReason String?
  isDeleted  Boolean      @default(false)
  deletedAt  DateTime?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Conversation {
  id            String    @id @default(cuid())
  user1Id       String
  user2Id       String
  blockedById   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastMessageAt DateTime?
  isBlocked     Boolean   @default(false)
  isArchived    Boolean   @default(false)
  archivedAt    DateTime?
  blockedBy     User?     @relation("BlockedByUser", fields: [blockedById], references: [id], onDelete: Cascade)
  user1         User      @relation("User1Conversations", fields: [user1Id], references: [id], onDelete: Cascade)
  user2         User      @relation("User2Conversations", fields: [user2Id], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@index([lastMessageAt])
}

model Message {
  id             String         @id @default(cuid())
  conversationId String
  senderId       String
  recipientId    String
  content        String?
  attachmentUrl  String?
  replyToId      String?
  isRead         Boolean        @default(false)
  readAt         DateTime?
  isEdited       Boolean        @default(false)
  editedAt       DateTime?
  isDeleted      Boolean        @default(false)
  deletedAt      DateTime?
  sentAt         DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  recipient      User           @relation("RecipientMessages", fields: [recipientId], references: [id], onDelete: Cascade)
  sender         User           @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  notifications  Notification[]

  @@index([conversationId])
  @@index([senderId])
  @@index([recipientId])
  @@index([sentAt])
  @@index([isRead])
}

model Report {
  id           String       @id @default(cuid())
  reporterId   String
  targetPostId String
  reason       String
  status       ReportStatus @default(PENDING)
  adminNote    String?
  isResolved   Boolean      @default(false)
  resolvedAt   DateTime?
  respondedAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  reporter     User         @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  targetPost   Post         @relation(fields: [targetPostId], references: [id], onDelete: Cascade)

  @@index([reporterId])
  @@index([targetPostId])
  @@index([status])
  @@index([createdAt])
}

model Story {
  id              String           @id @default(cuid())
  userId          String
  mediaUrl        String
  mediaType       StoryMediaType
  caption         String?
  userUsername    String
  userImage       String?
  viewCount       Int              @default(0)
  likeCount       Int              @default(0)
  location        String?
  visibilityScope StoryVisibility  @default(EVERYONE)
  isPrivate       Boolean          @default(false)
  isFlagged       Boolean          @default(false)
  flagReason      String?
  isDeleted       Boolean          @default(false)
  deletedAt       DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  expiresAt       DateTime
  notifications   Notification[]
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  highlights      StoryHighlight[]
  likes           StoryLike[]
  views           StoryView[]

  @@index([userId])
  @@index([expiresAt])
  @@index([mediaType])
  @@index([visibilityScope])
}

model StoryView {
  storyId    String
  viewerId   String
  viewedAt   DateTime @default(now())
  isPrivate  Boolean  @default(false)
  isFlagged  Boolean  @default(false)
  flagReason String?
  location   String?
  device     String?
  story      Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  viewer     User     @relation(fields: [viewerId], references: [id], onDelete: Cascade)

  @@id([storyId, viewerId])
  @@unique([storyId, viewerId], name: "storyId_viewerId")
  @@index([viewerId])
  @@index([viewedAt])
}

model StoryHighlight {
  id         String    @id @default(cuid())
  storyId    String
  userId     String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isDeleted  Boolean   @default(false)
  deletedAt  DateTime?
  title      String?
  coverImage String?
  isPinned   Boolean   @default(false)
  story      Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@index([userId])
  @@index([createdAt])
  @@index([isPinned])
}

model StoryLike {
  id        String    @id @default(cuid())
  storyId   String
  userId    String
  likedAt   DateTime  @default(now())
  isRemoved Boolean   @default(false)
  removedAt DateTime?
  device    String?
  location  String?
  story     Story     @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, storyId])
  @@index([storyId])
  @@index([userId])
  @@index([likedAt])
}

// Enums
enum Language { 
  EN
  AR
  FR
  ES
  DE
  PT
  RU
  ZH
  JA
  KO
}

enum ThemeMode {
  LIGHT
  DARK
  SYSTEM
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

enum VerificationType {
  EMAIL
  PASSWORD_RESET
  TWO_FACTOR
}

enum PostFormat {
  TEXT
  IMAGE
  VIDEO
  POLL
  LINK
}

enum PostType {
  STANDARD
  STORY
  REEL
  AD
}

enum PostVisibility {
  PUBLIC
  PRIVATE
  FOLLOWERS_ONLY
}

enum FollowRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

enum NotificationType {
  like_post
  comment
  comment_reply
  comment_liked
  post_mention
  comment_mention
  post_saved
  comment_tagged
  story_like
  story_view
  story_reply
  story_highlighted
  story_reshared
  story_expired
  message
  message_reply
  message_reacted
  message_seen
  conversation_started
  follow
  follow_request
  follow_accepted
  follow_declined
  mutual_follow
  profile_viewed
  suggested_to_others
  mention
  account_warning
  feature_announcement
  system_update
  feedback_response
  privacy_update
  security_alert
  content_flagged
}

enum UserMediaType {
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  OTHER
}

enum ActivityType {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  EMAIL_VERIFICATION
  PROFILE_UPDATE
  PROFILE_PICTURE_CHANGE
  COVER_PICTURE_CHANGE
  POST_CREATE
  POST_UPDATE
  POST_DELETE
  POST_LIKE
  POST_UNLIKE
  POST_SAVE
  POST_UNSAVE
  POST_SHARE
  POST_VIEW
  COMMENT_CREATE
  COMMENT_UPDATE
  COMMENT_DELETE
  COMMENT_LIKE
  COMMENT_UNLIKE
  FOLLOW
  UNFOLLOW
  FOLLOW_REQUEST_SENT
  FOLLOW_REQUEST_ACCEPTED
  FOLLOW_REQUEST_DECLINED
  FOLLOW_REQUEST_CANCELLED
  STORY_CREATE
  STORY_UPDATE
  STORY_DELETE
  STORY_VIEW
  STORY_LIKE
  STORY_UNLIKE
  STORY_HIGHLIGHT_CREATE
  STORY_HIGHLIGHT_DELETE
  MEDIA_UPLOAD
  MEDIA_DELETE
  MEDIA_UPDATE
  ACCOUNT_PRIVACY_CHANGE
  ACCOUNT_DEACTIVATE
  ACCOUNT_REACTIVATE
}

enum ReportStatus {
  PENDING
  REVIEWED
  REJECTED
  ACTION_TAKEN
}

enum StoryMediaType {
  IMAGE
  VIDEO
  AUDIO
}

enum StoryPrivacySetting {
  EVERYONE
  FOLLOWERS_ONLY
  MUTUALS
  PRIVATE
}

enum StoryVisibility {
  EVERYONE
  FOLLOWERS_ONLY
  MUTUALS
  NO_ONE
}